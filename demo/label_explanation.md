# 抓取检测标签图详细解释

## 四张标签图的含义

### 1. **抓取质量图 (pos)**
- **含义**: 表示每个像素位置是否适合进行抓取
- **数值**: 0 或 1（二值化）
- **颜色**: 蓝色=0（不可抓取），红色=1（可抓取）
- **形状**: 在抓取区域内为1，其他地方为0

### 2. **角度余弦图 (cos 2θ)**
- **含义**: 表示抓取角度的余弦值
- **数值范围**: -1 到 1
- **为什么连续**: 因为角度是连续变化的！
- **颜色映射**: 
  - 绿色 ≈ cos(2θ) = 1 → θ = 0° (水平抓取)
  - 红色 ≈ cos(2θ) = -1 → θ = 90° (垂直抓取)
  - 黄色 ≈ cos(2θ) = 0 → θ = 45° (倾斜抓取)

### 3. **角度正弦图 (sin 2θ)**
- **含义**: 表示抓取角度的正弦值
- **数值范围**: -1 到 1
- **为什么连续**: 与cos配合，完整描述角度信息
- **颜色映射**: HSV色彩空间，不同颜色代表不同角度

### 4. **抓取宽度图 (width)**
- **含义**: 表示抓取器需要张开的宽度
- **数值范围**: 0 到 1（归一化后）
- **为什么连续**: 不同物体需要不同的抓取宽度
- **颜色**: 蓝色=窄抓取，红色=宽抓取

## 为什么标签是连续的？

### 1. **物理意义**
- 抓取角度本身就是连续的（0°到180°）
- 抓取宽度也是连续的（小物体vs大物体）
- 这反映了真实世界抓取的连续性特征

### 2. **网络训练需要**
- 连续标签比离散标签包含更多信息
- 有利于网络学习更精确的抓取参数
- 支持亚像素级的精度

### 3. **数学表示**
```
角度 θ ∈ [0, π] (连续)
↓
cos(2θ), sin(2θ) ∈ [-1, 1] (连续)
```

## 多个抓取框的处理策略

### 1. **覆盖策略**
```python
for gr in self.grs:  # 遍历所有抓取矩形
    rr, cc = gr.compact_polygon_coords(shape)
    pos_out[rr, cc] = 1.0        # 后面的会覆盖前面的
    ang_out[rr, cc] = gr.angle   # 保留最后一个矩形的值
    width_out[rr, cc] = gr.length
```

### 2. **重叠区域处理**
- **问题**: 多个抓取框重叠时，应该用哪个角度？
- **解决**: 使用最后一个处理的抓取框的参数
- **原理**: 假设后面的抓取框更重要或更准确

### 3. **实际效果**
- 重叠区域会显示最后一个抓取框的角度和宽度
- 这可能导致标签图中出现"拼接"效果
- 但pos图始终为1（只要有任何抓取框覆盖）

## 标签应该是怎样的？

### 理想情况下的标签特征：

1. **pos图**: 清晰的二值化区域，标记所有可抓取位置
2. **cos/sin图**: 平滑的颜色过渡，反映角度的连续变化
3. **width图**: 根据物体大小的连续宽度值

### 常见的标签模式：

```
单个物体: 
├─ pos: 单个连通区域
├─ cos/sin: 区域内颜色统一
└─ width: 区域内数值相近

多个物体:
├─ pos: 多个分离的区域  
├─ cos/sin: 不同区域可能有不同颜色
└─ width: 不同区域对应不同宽度

重叠抓取框:
├─ pos: 合并的区域
├─ cos/sin: 边界处可能有突变
└─ width: 可能出现不连续跳跃
```

## 改进建议

### 1. **更好的多框处理**
```python
# 可以使用平均值而不是覆盖
ang_out[rr, cc] = (ang_out[rr, cc] + gr.angle) / 2
```

### 2. **权重融合**
```python
# 基于距离中心的权重
weight = distance_to_center(rr, cc, gr.center)
ang_out[rr, cc] = weighted_average(ang_out[rr, cc], gr.angle, weight)
```

### 3. **标签平滑**
- 在抓取框边界处进行平滑处理
- 避免角度的突然跳跃
- 提高训练稳定性
